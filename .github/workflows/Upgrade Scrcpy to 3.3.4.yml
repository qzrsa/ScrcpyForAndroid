name: Upgrade Scrcpy to Specific Version

on:
  workflow_dispatch:
    inputs:
      scrcpy_version:
        description: 'Scrcpy version to upgrade to (e.g., 3.3.4)'
        required: true
        default: '3.3.4'

jobs:
  upgrade:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Check if version exists
      id: check-version
      run: |
        VERSION="${{ github.event.inputs.scrcpy_version }}"
        echo "Checking Scrcpy version v${VERSION}..."
        
        # æ£€æŸ¥è¯¥ç‰ˆæœ¬æ˜¯å¦å­˜åœ¨
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
          "https://github.com/Genymobile/scrcpy/releases/tag/v${VERSION}")
        
        if [ "$HTTP_CODE" != "200" ]; then
          echo "Error: Scrcpy version v${VERSION} does not exist!"
          exit 1
        fi
        
        echo "Version v${VERSION} found!"
        
    - name: Download Scrcpy server binary
      run: |
        VERSION="${{ github.event.inputs.scrcpy_version }}"
        echo "Downloading scrcpy-server v${VERSION}..."
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p temp_download
        cd temp_download
        
        # ä¸‹è½½ scrcpy-server æ–‡ä»¶
        wget "https://github.com/Genymobile/scrcpy/releases/download/v${VERSION}/scrcpy-server-v${VERSION}" \
          -O scrcpy-server-v${VERSION}
        
        # éªŒè¯æ–‡ä»¶å·²ä¸‹è½½
        if [ ! -f "scrcpy-server-v${VERSION}" ]; then
          echo "Error: Failed to download scrcpy-server"
          exit 1
        fi
        
        echo "Downloaded: $(ls -lh scrcpy-server-v${VERSION})"
        cd ..
        
    - name: Update project files
      run: |
        VERSION="${{ github.event.inputs.scrcpy_version }}"
        
        # åˆ›å»º assets ç›®å½•
        mkdir -p app/src/main/assets
        
        # ç§»åŠ¨ scrcpy-server æ–‡ä»¶
        mv temp_download/scrcpy-server-v${VERSION} app/src/main/assets/scrcpy-server
        
        # åˆ›å»ºæˆ–æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        echo "${VERSION}" > app/src/main/assets/scrcpy-version.txt
        
        # å¦‚æœæœ‰ README,æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
        if [ -f "README.md" ]; then
          sed -i "s/Scrcpy [0-9.]\+/Scrcpy ${VERSION}/g" README.md || true
          sed -i "s/scrcpy-[0-9.]\+/scrcpy-${VERSION}/g" README.md || true
        fi
        
        # æ›´æ–° app/build.gradle.kts ä¸­çš„ç‰ˆæœ¬å·(å¦‚æœæœ‰ç›¸å…³æ³¨é‡Š)
        if [ -f "app/build.gradle.kts" ]; then
          # åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ æˆ–æ›´æ–°æ³¨é‡Š
          if grep -q "// Scrcpy version:" app/build.gradle.kts; then
            sed -i "s#// Scrcpy version: .*#// Scrcpy version: ${VERSION}#g" app/build.gradle.kts
          else
            sed -i "1i// Scrcpy version: ${VERSION}" app/build.gradle.kts
          fi
        fi
        
        echo "Files updated successfully!"
        
    - name: Clean up
      run: |
        rm -rf temp_download
        
    - name: Verify changes
      run: |
        echo "=== Modified files ==="
        git status
        echo ""
        echo "=== Assets directory ==="
        ls -lh app/src/main/assets/ || echo "Assets directory not found"
        
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: upgrade Scrcpy to v${{ github.event.inputs.scrcpy_version }}"
        title: "å‡çº§ Scrcpy åˆ° v${{ github.event.inputs.scrcpy_version }}"
        body: |
          ## ğŸš€ è‡ªåŠ¨å‡çº§ Scrcpy ç‰ˆæœ¬
          
          **æ–°ç‰ˆæœ¬**: v${{ github.event.inputs.scrcpy_version }}
          
          ### ğŸ“¦ æ›´æ”¹å†…å®¹
          - âœ… ä¸‹è½½æœ€æ–°çš„ scrcpy-server äºŒè¿›åˆ¶æ–‡ä»¶
          - âœ… æ›´æ–°åˆ° `app/src/main/assets/scrcpy-server`
          - âœ… åˆ›å»ºç‰ˆæœ¬æ ‡è®°æ–‡ä»¶
          - âœ… æ›´æ–°ç›¸å…³æ–‡æ¡£
          
          ### ğŸ“ å‘å¸ƒè¯´æ˜
          æŸ¥çœ‹ Scrcpy v${{ github.event.inputs.scrcpy_version }} çš„å®Œæ•´å‘å¸ƒè¯´æ˜:
          https://github.com/Genymobile/scrcpy/releases/tag/v${{ github.event.inputs.scrcpy_version }}
          
          ---
          ğŸ¤– æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º
        branch: upgrade-scrcpy-v${{ github.event.inputs.scrcpy_version }}
        delete-branch: true
        labels: |
          enhancement
          dependencies
