name: å‡çº§ Scrcpy ç‰ˆæœ¬

on:
  workflow_dispatch:
    inputs:
      scrcpy_version:
        description: 'Scrcpy ç‰ˆæœ¬ (ä¾‹å¦‚: v3.3.4)'
        required: true
        default: 'v3.3.4'
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  upgrade:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: é…ç½® Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: åˆ›å»ºå‡çº§åˆ†æ”¯
      run: |
        BRANCH_NAME="upgrade-scrcpy-${{ inputs.scrcpy_version }}"
        git checkout -b $BRANCH_NAME
        echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
    
    - name: ä¸‹è½½ Scrcpy Server
      run: |
        VERSION="${{ inputs.scrcpy_version }}"
        echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½ Scrcpy Server ${VERSION}..."
        
        # ä¸‹è½½å®˜æ–¹ server
        wget https://github.com/Genymobile/scrcpy/releases/download/${VERSION}/scrcpy-server-${VERSION} -O scrcpy-server-temp.jar
        
        # éªŒè¯ä¸‹è½½
        if [ ! -f scrcpy-server-temp.jar ]; then
          echo "âŒ ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
        FILE_SIZE=$(stat -c%s scrcpy-server-temp.jar)
        echo "âœ… ä¸‹è½½æˆåŠŸ,æ–‡ä»¶å¤§å°: $FILE_SIZE bytes"
        
        # åˆ›å»º assets ç›®å½•(å¦‚æœä¸å­˜åœ¨)
        mkdir -p app/src/main/assets
        
        # æ›¿æ¢æ—§çš„ server æ–‡ä»¶
        mv scrcpy-server-temp.jar app/src/main/assets/scrcpy-server.jar
        
        echo "âœ… Server æ–‡ä»¶å·²æ›´æ–°"
    
    - name: æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
      run: |
        VERSION="${{ inputs.scrcpy_version }}"
        VERSION_NUM="${VERSION#v}"  # ç§»é™¤ 'v' å‰ç¼€
        
        echo "ğŸ“ æ›´æ–°ç‰ˆæœ¬å·åˆ° ${VERSION_NUM}..."
        
        # æ›´æ–° app/build.gradle
        sed -i "s/versionName \".*\"/versionName \"${VERSION_NUM}\"/" app/build.gradle
        
        # é€’å¢ versionCode
        CURRENT_CODE=$(grep "versionCode" app/build.gradle | head -1 | awk '{print $2}')
        NEW_CODE=$((CURRENT_CODE + 1))
        sed -i "0,/versionCode [0-9]*/s//versionCode $NEW_CODE/" app/build.gradle
        
        echo "âœ… ç‰ˆæœ¬ä¿¡æ¯å·²æ›´æ–°: versionCode $NEW_CODE, versionName ${VERSION_NUM}"
        echo "VERSION_NUM=$VERSION_NUM" >> $GITHUB_ENV
        echo "VERSION_CODE=$NEW_CODE" >> $GITHUB_ENV
    
    - name: è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: æˆäºˆæ‰§è¡Œæƒé™
      run: chmod +x gradlew
    
    - name: ç¼–è¯‘æµ‹è¯• (Debug ç‰ˆæœ¬)
      run: |
        echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘æµ‹è¯•..."
        ./gradlew assembleDebug --stacktrace
        
        if [ $? -eq 0 ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸ"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          exit 1
        fi
    
    - name: æäº¤æ›´æ”¹
      run: |
        # ä½¿ç”¨ -f å¼ºåˆ¶æ·»åŠ è¢« .gitignore å¿½ç•¥çš„æ–‡ä»¶
        git add -f app/src/main/assets/scrcpy-server.jar
        git add app/build.gradle
        
        git commit -m "ğŸš€ å‡çº§ Scrcpy Server åˆ° ${{ inputs.scrcpy_version }}
        
        - ä¸‹è½½å¹¶æ›¿æ¢å®˜æ–¹ scrcpy-server.jar
        - æ›´æ–°ç‰ˆæœ¬å·åˆ° ${{ env.VERSION_NUM }}
        - versionCode é€’å¢åˆ° ${{ env.VERSION_CODE }}
        - ç¼–è¯‘æµ‹è¯•é€šè¿‡
        
        è‡ªåŠ¨ç”Ÿæˆäº GitHub Actions"
    
    - name: æ¨é€åˆ†æ”¯
      run: |
        git push origin ${{ env.BRANCH_NAME }}
    
    - name: åˆ›å»º Pull Request
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PR_BODY="## ğŸ“¦ è‡ªåŠ¨å‡çº§ Scrcpy Server
        
        ### æ›´æ–°å†…å®¹
        - âœ… ç‰ˆæœ¬: ${{ inputs.scrcpy_version }}
        - âœ… versionName: ${{ env.VERSION_NUM }}
        - âœ… versionCode: ${{ env.VERSION_CODE }}
        - âœ… ä¸‹è½½å®˜æ–¹ scrcpy-server.jar å¹¶æ›¿æ¢
        - âœ… Debug ç¼–è¯‘æµ‹è¯•é€šè¿‡
        
        ### å˜æ›´æ–‡ä»¶
        - app/src/main/assets/scrcpy-server.jar - å®˜æ–¹ Server ${{ inputs.scrcpy_version }}
        - app/build.gradle - ç‰ˆæœ¬ä¿¡æ¯æ›´æ–°
        
        ### æµ‹è¯•æ¸…å•
        åˆå¹¶å‰è¯·æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½:
        - [ ] åŸºæœ¬è¿æ¥ (æœ‰çº¿/æ— çº¿)
        - [ ] è§†é¢‘æŠ•å±æ˜¾ç¤º
        - [ ] è§¦æ§æ“ä½œå“åº”
        - [ ] Android 5-15 è®¾å¤‡å…¼å®¹æ€§
        - [ ] é«˜åˆ†è¾¨ç‡æ”¯æŒ
        - [ ] éŸ³é¢‘åŒæ­¥(å¦‚æœæ”¯æŒ)
        
        ### å®˜æ–¹æ›´æ–°æ—¥å¿—
        æŸ¥çœ‹ scrcpy ${{ inputs.scrcpy_version }} çš„å®Œæ•´æ›´æ–°æ—¥å¿—:
        https://github.com/Genymobile/scrcpy/releases/tag/${{ inputs.scrcpy_version }}
        
        ---
        *ğŸ¤– æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*"
        
        gh pr create \
          --title "ğŸš€ å‡çº§ Scrcpy Server åˆ° ${{ inputs.scrcpy_version }}" \
          --body "$PR_BODY" \
          --base main \
          --head ${{ env.BRANCH_NAME }}
    
    - name: ä¸Šä¼  Debug APK ä¾›æµ‹è¯•
      uses: actions/upload-artifact@v4
      with:
        name: scrcpy-${{ env.VERSION_NUM }}-debug-test
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 7
